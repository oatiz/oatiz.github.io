<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--meta http-equiv="content-type" content="text/html; charset=utf-8"-->

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
<title>&#x2F;home&#x2F;oatiz - Raft学习笔记</title>


    
    <link rel="icon" href=https:&#x2F;&#x2F;github.com&#x2F;GalAster&#x2F;zola-theme-mikoto>
    

    

    
    <script src=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;basic.js></script>
    <script src=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;lib&#x2F;pjax.js></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
    

<script src=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;lib&#x2F;mathjax.js></script>
<script id="MathJax-script" async src=https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;mathjax@3&#x2F;es5&#x2F;tex-chtml.js></script>


    

<link rel="stylesheet" href="https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;katex@latest/dist/katex.min.css" crossorigin="anonymous">
<script type="module">
import renderMathInElement from "https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.mjs";
const katex_config = {
    delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
    ],
    macros: {
        // Functions
        arccot: '\\operatorname{arccot}',
        arcsec: '\\operatorname{arcsec}',
        arccsc: '\\operatorname{arccsc}',
    }
}
renderMathInElement(document.body, katex_config);
</script>



    

    


    

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;site.css>
    

    
    
</head>

<body>
<div class="loading-bar">
    <div class="progress"></div>
</div>
<div class="container">
    
<a href=https:&#x2F;&#x2F;github.com&#x2F;GalAster&#x2F;zola-theme-mikoto class="github-corner" aria-label="View on GitHub">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>

    <div id="mobile-navbar" class="mobile-navbar">
        <div class="mobile-header-logo">
            <a href="/" class="logo">oatiz</a>
        </div>
        <div class="mobile-navbar-icon icon-out">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
        <ul class="mobile-menu-list">
            
            <li class="mobile-menu-item">
                <a href=https:&#x2F;&#x2F;blog.oatiz.me> Home </a>
            </li>
            
            <li class="mobile-menu-item">
                <a href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;categories> Categories </a>
            </li>
            
            <li class="mobile-menu-item">
                <a href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;tags> Tags </a>
            </li>
            
            <li class="mobile-menu-item">
                <a href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;about> About </a>
            </li>
            
        </ul>
    </nav>

    <header id="header">
        <div class="logo"><a href=https:&#x2F;&#x2F;blog.oatiz.me>oatiz</a></div>
        <nav class="menu">
            <ul>
                
                <li>
                    <a href=https:&#x2F;&#x2F;blog.oatiz.me> Home </a>
                </li>
                
                <li>
                    <a href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;categories> Categories </a>
                </li>
                
                <li>
                    <a href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;tags> Tags </a>
                </li>
                
                <li>
                    <a href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;about> About </a>
                </li>
                
            </ul>
        </nav>
    </header>

    <main>
        <div class="content" id="mobile-panel">
            




<article class="post">
    
<header class="post__header">
    <h1 class="post__title">
        <a href="https:&#x2F;&#x2F;blog.oatiz.me&#x2F;raft-summary&#x2F;">Raft学习笔记</a>
    </h1>
    <div class="post__meta">
        <i class="fa fa-calendar-o" aria-hidden="true"></i>
        <span> 2018-12-07&nbsp;&nbsp;</span>
        <i class="fa fa-font" aria-hidden="true"></i>
        <span>&nbsp;2922 words&nbsp;&nbsp;</span>
        <i class="fa fa-clock-o" aria-hidden="true"></i>
        <span>&nbsp;15 minute read&nbsp;&nbsp;</span>
        
    </div>
</header>

    
<div class="post-labels">
    
    
    <a class="category" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;categories&#x2F;distributed-systems&#x2F;># Distributed Systems</a>
    
    

    
    
    <a class="tag" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;tags&#x2F;raft&#x2F;># raft</a>
    
    <a class="tag" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;tags&#x2F;cap&#x2F;># cap</a>
    
    <a class="tag" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;tags&#x2F;distributed-consensus&#x2F;># distributed consensus</a>
    
    
</div>


    <div class="post-content">
        <h2 id="gai-nian">概念</h2>
<blockquote>
<p><code>Raft</code> is an algorithm for managing a replicated log.</p>
</blockquote>
<p><code>Raft</code>是一种用来管理复制日志的一致性算法.</p>
<span id="continue-reading"></span><h2 id="shi-xian">实现</h2>
<blockquote>
<p><code>Raft</code> implements consensus by first electing a distinguished leader, then giving the leader complete responsibility for managing the replicated log. The leader accepts log entries from clients, replicates them on other servers, and tells servers when it is safe to apply log entries to their state machines.</p>
</blockquote>
<p><code>Raft</code>通过<u>选举</u>一个高贵的<u>领导人</u>,然后给予它<u>全部职责</u>来<u>管理复制日志</u>从而实现一致性. 领导人接收来自客户端的日志,在其他服务器上复制它们,并告诉服务器当它们是安全的情况下将这些日志应用到状态机.</p>
<hr />
<p><code>Raft</code>将共识问题分解为三个相对独立的子问题:</p>
<ul>
<li>Leader election: a new leader must be to chosen when an existing leader fails
<ul>
<li>领导人选举: 当已存在的领导人宕机时新的领导人必须要被选出来</li>
</ul>
</li>
<li>Log replication: the leader must accept log entries from clients and replicate them across the cluster, forcing the other logs to agree with its own
<ul>
<li>日志复制: 领导人必须从客户端接收日志然后复制到集群中的其他节点, 并且强制要求其他节点的日志和自己相同</li>
</ul>
</li>
<li>Safety: the key safety property for <em>Raft</em> is the <em>State Machine</em> Property : if any server has applied a particular log entry to its <em>state machine</em>, then no other server may apply a different command for same log index.
<ul>
<li>安全性: Raft的安全性关键是状态机安全: 如果任何服务器已将特定日志条目应用于其状态机,那么其他服务器不能在同一日志索引位置应用不同的命令</li>
</ul>
</li>
</ul>
<h3 id="safety">Safety</h3>
<h4 id="election-safety">Election Safety</h4>
<p>选举安全特性</p>
<blockquote>
<p>at most one leader can be elected in a given term.
在一个给定的任期号, 最多只有一个领导人会被选举出来</p>
</blockquote>
<h4 id="leader-append-only">Leader Append-Only</h4>
<p>领导人只附加原则</p>
<blockquote>
<p>a leader never overwrites or deletes entries in its log; it only appends new entries.
领导人永远不会覆盖或删除其日志中的条目; 它只附加新条目.</p>
</blockquote>
<h4 id="log-matching">Log Matching</h4>
<p>日志匹配原则</p>
<blockquote>
<p>if two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index.
如果两个日志在相同索引位置的日志条目的任期号相同, 那么这两个日志从头到这个索引位置的都是相同的.</p>
</blockquote>
<h4 id="leader-completeness">Leader Completeness</h4>
<p>领导人完全特性</p>
<blockquote>
<p>if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.
如果在给定的任期中提交了某条日志条目, 则该日志条目必然出现在所有更高任期编号的领导人的日志中.</p>
</blockquote>
<h4 id="state-machine-safety">State Machine Safety</h4>
<p>状态机安全特性</p>
<blockquote>
<p>if a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index.
如果服务器已将给定索引处的日志条目应用于其状态机, 那么其他服务器不会在同一索引提交不同的日志条目.</p>
</blockquote>
<h2 id="jing-jian-zhai-yao">精简摘要</h2>
<h3 id="role">Role</h3>
<h4 id="struct">struct</h4>
<pre style="background-color:#2b303b;">
<code><span style="color:#cd74e8;">pub enum </span><span style="color:#abb2bf;">StateRole {
    </span><span style="font-style:italic;color:#5f697a;">/// The node is a follower of the leader.
</span><span style="color:#abb2bf;">    Follower,
    </span><span style="font-style:italic;color:#5f697a;">/// The node could become a leader.
</span><span style="color:#abb2bf;">    Candidate,
    </span><span style="font-style:italic;color:#5f697a;">/// The node is a leader.
</span><span style="color:#abb2bf;">    Leader,
}
</span></code></pre><h3 id="state">State</h3>
<h4 id="struct-1">struct</h4>
<pre style="background-color:#2b303b;">
<code><span style="color:#cd74e8;">pub struct </span><span style="color:#abb2bf;">State {
    </span><span style="font-style:italic;color:#5f697a;">// Persistent state on all servers (Updated on stable storage before responding to RPCs)
    // 持久化在所有服务器上的状态 (在响应RPC之前更新)
    
    /// 1. currentTerm
    ///     latest term server has seen (initialized to 0 on first boot, increases monotonically)
    ///     服务器已知的最后一次任期号 (初始化为0,持续增加)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">current_term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 2. votedFor
    ///     candidateId that received vote in current term (or null if none)
    ///     在当前任期内获得该节点投票的候选人id (没有就为null)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">voted_for</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 3. log[]
    ///     log entries; each entry contains command for state machine, and term when entry was received by leader (first index is 1)
    ///     日志集合; 每个记录包含状态机的命令, 以及领导者收到条目时的任期 (第一个索引为1)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">log</span><span style="color:#abb2bf;">: Vec![],
    
    </span><span style="font-style:italic;color:#5f697a;">/// Volatile state on all servers
    /// 在所有服务器上面容易变的状态
    
    /// 4. commitIndex
    ///     index of highest log entry known to be committed (initialized to 0, increases monotonically)
    ///     已知最大的被提交日志的索引 (初始化为0, 持续增加)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">commit_index</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 5. lastApplied
    ///     index of highest log entry applied to state machine (initialized to 0, increases monotonically)
    ///     最后应用于状态机的日志索引 (初始化为0, 持续增加)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">last_applied</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    
    </span><span style="font-style:italic;color:#5f697a;">/// Volatile state on leaders: (Reinitialized after election)
    /// 在领导人上面易变的状态 (选举之后重新初始化)
    
    /// 6. nextIndex[]
    ///     for each server, index of the next log entry to send to that server (initialized to leader last log index + 1)
    ///     对于每个服务器,要发送到该服务器的下一个日志条目的索引 (初始化为领导人最后日志索引 + 1)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">next_index</span><span style="color:#abb2bf;">: Vec![],
    
    </span><span style="font-style:italic;color:#5f697a;">/// 7. matchIndex[]
    ///     for each server, index of highest log entry known to be replicated on server (initialized to 0, increases monotonically)
    ///     对于每个服务器, 已经在服务器上复制的最高日志条目的索引 (初始化为0, 持续递增)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">match_index</span><span style="color:#abb2bf;">: Vec![],
}
</span></code></pre><h3 id="appendentries-rpc">AppendEntries RPC</h3>
<h4 id="struct-2">struct</h4>
<pre style="background-color:#2b303b;">
<code><span style="font-style:italic;color:#5f697a;">/// Invoked by leader to replicate log entries ; also used as heartbeat
/// 由leader调用来复制日志; 也用作发送心跳包
</span><span style="color:#cd74e8;">pub struct </span><span style="color:#abb2bf;">AppendEntriesRPC {
    </span><span style="font-style:italic;color:#5f697a;">/// 1. term
    ///     leader’s term
    ///     领导人的任期号
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 2. leaderId
    ///     so follower can redirect clients
    ///     领导人的id,便于跟随者可以重定向客户端
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">leader_id</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 3. prevLogIndex
    ///     index of log entry immediately preceding new ones
    ///     紧接之前的,新的日志条目的索引
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">prev_log_index</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 4. prevLogTerm
    ///     term of prevLogIndex entry
    ///     prevLogIndex日志条目的索引值
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">prev_log_term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 5. entries[]
    ///     log entries to store (empty for heartbeat; may send more than one for efficiency)
    ///     需要被保存的日志集合 (为空时表示心跳; 为了提升效率可能会发送多个)
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">entries</span><span style="color:#abb2bf;">: Vec![],
    
    </span><span style="font-style:italic;color:#5f697a;">/// 6. leaderCommit
    ///     leader’s commitIndex
    ///     领导人的 被提交日志的最大索引
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">leader_commit</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
}

</span><span style="color:#cd74e8;">pub struct </span><span style="color:#abb2bf;">Result {
    </span><span style="font-style:italic;color:#5f697a;">/// 1. term
    ///     currentTerm, for leader to update itself
    ///     当前任期号, 供领导者更新自己
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 2. success
    ///     true if follower contained entry matching prevLogIndex and prevLogTerm
    ///     如果跟随者包含匹配prevLogIndex和prevLogTerm的日志条目, 则返回true
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">success</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">bool</span><span style="color:#abb2bf;">,
}
</span></code></pre><h4 id="receiver-implementation">Receiver implementation</h4>
<ul>
<li>Reply false if term &lt; currentTerm
<ul>
<li>如果term &lt; currentTerm, 则返回false</li>
</ul>
</li>
<li>Reply false if log doesn’t contain an entry at prevLogIndex whose term matches prevLogTerm
<ul>
<li>如果日志在prevLogIndex位置的条目,它的任期号与prevLogTerm不匹配,则返回false</li>
</ul>
</li>
<li>If an existing entry conflicts with a new one (same index but different terms), delete the existing entry and all that follow it
<ul>
<li>如果已有日志条目与新的日志条目冲突 (索引相同但任期号不同), 删除已有日志条目及其后面的所有日志条目</li>
</ul>
</li>
<li>Append any new entries not already in the log
<ul>
<li>附加在日志中尚未存在的任何新日志条目</li>
</ul>
</li>
<li>If <code>leaderCommit &gt; commitIndex</code>, set <code>commitIndex = min(leaderCommit, index of last new entry)</code>
<ul>
<li>如果leaderCommit大于commitIndex, 则设置commitIndex等于 (领导人提交日志的最大索引, 新日志条目中最后的一个的索引) 两个中最小的值</li>
</ul>
</li>
</ul>
<h3 id="requestvote-rpc">RequestVote RPC</h3>
<h4 id="struct-3">struct</h4>
<pre style="background-color:#2b303b;">
<code><span style="font-style:italic;color:#5f697a;">/// Invoked by candidates to gather votes
/// 由候选人调用来收集选票
</span><span style="color:#cd74e8;">pub struct </span><span style="color:#abb2bf;">RequestVoteRPC {
    </span><span style="font-style:italic;color:#5f697a;">/// 1. term
    ///     candidate’s term
    ///     候选人的任期号
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 2. candidateId
    ///     candidate requesting vote
    ///     候选人的id, 候选人要求投票
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">candidate_id</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 3. lastLogIndex
    ///     index of candidate’s last log entry
    ///     候选人最后一个日志条目的索引
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">last_log_index</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 4. lastLogTerm
    ///     term of candidate’s last log entry
    ///     候选人最后一个日志条目的任期号
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">last_log_term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
}

</span><span style="color:#cd74e8;">pub struct </span><span style="color:#abb2bf;">Result {
    </span><span style="font-style:italic;color:#5f697a;">/// 1. term
    ///     currentTerm, for candidate to update itself
    ///     当前任期号, 供候选人更新自己
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">term</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">u64</span><span style="color:#abb2bf;">,
    
    </span><span style="font-style:italic;color:#5f697a;">/// 2. voteGranted
    ///     true means candidate received vote
    ///     true表示候选人获得投票
    </span><span style="color:#cd74e8;">pub </span><span style="color:#eb6772;">vote_granted</span><span style="color:#abb2bf;">: </span><span style="color:#cd74e8;">bool</span><span style="color:#abb2bf;">,
}
</span></code></pre><h4 id="receiver-implementation-1">Receiver implementation</h4>
<ul>
<li>Reply false if <code>term &lt; currentTerm</code>
<ul>
<li>如果term小于currentTerm, 则返回false</li>
</ul>
</li>
<li>If votedFor is null or candidateId, and candidate’s log is at least as up-to-date as receiver’s log, grant vote
<ul>
<li>如果votedFor等于null或candidateId, 并且候选人的日志至少与接收者的日志一样新时, 则投票给它</li>
</ul>
</li>
</ul>
<h3 id="rules-for-servers">Rules for Servers</h3>
<h4 id="all-servers">All Servers</h4>
<ul>
<li>If <code>commitIndex &gt; lastApplied</code>: increment lastApplied, apply log[lastApplied] to state machine
<ul>
<li>如果commitIndex大于lastApplied: 那么将lastApplied + 1, 并将log[lastApplied]应用到状态机</li>
</ul>
</li>
<li>If RPC request or response contains <code>term T &gt; currentTerm</code>: set <code>currentTerm = T</code>, convert to follower
<ul>
<li>如果RPC请求或响应中 任期号<code>T</code>大于<code>currentTerm</code>: 那么就将currentTerm设置为任期号T, 并转换为follower</li>
</ul>
</li>
</ul>
<h4 id="followers">Followers</h4>
<ul>
<li>Respond to RPCs from candidates and leaders
<ul>
<li>响应候选人和领导人的RPC请求</li>
</ul>
</li>
<li>If election timeout elapses without receiving AppendEntries RPC from current leader or granting vote to candidate: convert to candidate
<ul>
<li>如果在选举超时前没有从当前领导者接收到AppendEntries RPC,或者是候选人的RequestVote RPC时: 就将自己转换为候选人</li>
</ul>
</li>
</ul>
<h4 id="candidates">Candidates</h4>
<ul>
<li>On conversion to candidate, start election
<ul>
<li>转换为候选人后, 立即开始选举
<ul>
<li>Increment currentTerm
<ul>
<li>自增当前的任期号</li>
</ul>
</li>
<li>Vote for self
<ul>
<li>给自己投票 </li>
</ul>
</li>
<li>Reset election timer
<ul>
<li>重置选举超时计时器 </li>
</ul>
</li>
<li>Send RequestVote RPCs to all other servers 
<ul>
<li>发送RequestVote RPC给其他所有服务器</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>If votes received from majority of servers: become leader
<ul>
<li>如果获得大多数服务器的选票: 那么就变成领导人</li>
</ul>
</li>
<li>If AppendEntries RPC received from new leader: convert to follower
<ul>
<li>如果接收到新领导人的AppendEntries RPC: 那么就转变为跟随者</li>
</ul>
</li>
<li>If election timeout elapses: start new election
<ul>
<li>如果选举超时: 再发起一轮新选举</li>
</ul>
</li>
</ul>
<h4 id="leaders">Leaders</h4>
<ul>
<li>Upon election: send initial empty AppendEntries RPCs (heartbeat) to each server; repeat during idle periods to prevent election timeouts
<ul>
<li>领导人当选时: 将空的AppendEntries RPC (心跳) 发送到每个服务器; 在一定空闲期间后不停重复发送以防止选举超时 (阻止跟随者没有收到心跳时,将自己变为候选人)</li>
</ul>
</li>
<li>If command received from client: append entry to local log, respond after entry applied to state machine
<ul>
<li>如果从客户端收到请求: 将日志条目附加到本地日志, 在日志条目被应用于状态机后响应客户端</li>
</ul>
</li>
<li>If last log <code>index ≥ nextIndex</code> for a follower: send AppendEntries RPC with log entries starting at nextIndex
<ul>
<li>对于某个跟随者, 如果<u>最后面的日志索引</u>的大于等于<code>nextIndex</code>: 那么发送AppendEntries RPC 从nextIndex开始的所有日志条目
<ul>
<li>If successful: update nextIndex and matchIndex for follower
<ul>
<li>如果成功: 更新相应跟随者的nextIndex和matchIndex </li>
</ul>
</li>
<li>If AppendEntries fails because of log inconsistency: decrement nextIndex and retry
<ul>
<li>如果因为日志不一致而失败: 递减nextIndex并重试</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>If there exists an N such that <code>N &gt; commitIndex</code>, a majority of <code>matchIndex[i] ≥ N</code>, and <code>log[N].term == currentTerm</code>: set <code>commitIndex = N</code>
<ul>
<li>如果存在一个满足N &gt; commitIndex的N, 并且大多数matchIndex[i] &gt;= N成立, 并且log[N].term == currentTerm成立: 那么就设置commitIndex等于这个N</li>
</ul>
</li>
</ul>
<h1 id="draft">draft</h1>
<hr />
<h2 id="log-replication-ri-zhi-fu-zhi">log replication(日志复制)</h2>
<ul>
<li>
<p>系统所有的更改都通过leader操作</p>
</li>
<li>
<p>每个更改都会作为 节点日志的一个条目</p>
</li>
<li>
<p>当前日志条目没有提交,所以不会更新节点的值</p>
</li>
<li>
<p>要提交此日志条目,首先要将其复制到follower节点们</p>
</li>
<li>
<p>然后leader等待到大多数节点写入此条目</p>
</li>
<li>
<p>当前条目提交到该leader节点</p>
</li>
<li>
<p>然后leader节点通知follow节点们此条目被提交</p>
</li>
</ul>
<h2 id="timeout">timeout</h2>
<blockquote>
<p>在raft中有两个超时设置来控制选举</p>
</blockquote>
<ol>
<li>election timeout (选举超时)
选举超时的值是介于150ms和300ms的随机值,</li>
</ol>
<ul>
<li>
<p>选举超时后,follower节点将变成candidate节点并重新开始一个选举.</p>
</li>
<li>
<p>投票给自己,并向其他节点发送投票请求消息</p>
</li>
<li>
<p>如果收到此消息的节点在这个选举期内没有投过票,那就会投票给该candidate,并且重设选举超时时间</p>
</li>
<li>
<p>一旦该候选人获得大多数投票,它就会变为leader节点</p>
</li>
<li>
<p>leader节点会开始向follower发送<code>append entries(附近条目)</code> 消息</p>
</li>
<li>
<p>这些消息按心跳超时指定的间隔发送</p>
</li>
<li>
<p>然后follower节点会回复每个<code>append entries(附近条目)</code>消息</p>
</li>
<li>
<p>这个选举周期会持续到follower节点停止心跳成为新的candidate节点</p>
</li>
</ul>
<pre style="background-color:#2b303b;">
<code><span style="color:#abb2bf;">graph LR
A[ ] --&gt;|starts up| Follower[Follower]
Follower --&gt; | times out, starts election| Candidate{Candidate}
Candidate --&gt; |receives votes from majority of servers| Leader((Leader))
Candidate --&gt; |discovers current leader or new term| Follower
Leader --&gt; |discovers server with higher term| Follower
Candidate --&gt; |times out, new election| Candidate
</span></code></pre>
    </div>

    

    

    <div class="post-footer">
        
        

        <div class="footer-buttons">
            <button type="button" class="footer"><span class="text"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i>&nbsp;&nbsp;赞赏</span></button>
            <button type="button" class="footer footer-weak"><span class="text"><i class="fa fa-share-square-o" aria-hidden="true"></i>&nbsp;&nbsp;分享</span></button>
        </div>


        
        <div class="post-nav">
            
            <a class="next" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;rust-ownership&#x2F;>Rust中所有权,引用,生命周期小记 ›</a>
            
            
            <a class="previous" href=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;kubernetes-summary&#x2F;>‹ k8s部署笔记</a>
            
            
            
        </div>
        

        

    </div>

    
    
</article>



        </div>
    </main>

    <footer id="footer">

    </footer>
</div>
<footer id="footer">
    
    
    <div class="container">
        <div class="bottom-bar">
            Made 
            by
            <a href="https://github.com/GalAster/zola-theme-mikoto" target="_blank" rel="noopener noreferrer">Aster</a>
        </div>
    </div>
    
</footer>

<script type="text/javascript" src=https:&#x2F;&#x2F;blog.oatiz.me&#x2F;lib&#x2F;init.js></script>

</body>
</html>
